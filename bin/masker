#!/bin/bash

# 定義正規表示式
IPV4_REGEX='(\d{1,3}\.){3}\d{1,3}'
IPV6_REGEX='(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))'
KEY_REGEX='sk-[a-zA-Z0-9]{32}'

mask_logic() {
  perl -pe "
    s/$IPV4_REGEX/[IPV4_REDACTED]/g;
    s/$IPV6_REGEX/[IPV6_REDACTED]/g;
    s/password\s*[:=]\s*['\"].*?['\"]/password: \"[REDACTED]\"/gi;
    s/$KEY_REGEX/[API_KEY_REDACTED]/g;
  "
}

if [[ "$1" == "-c" || "$1" == "--clipboard" ]]; then
  # 讀取剪貼簿 -> 處理 -> 同時輸出到畫面並回寫剪貼簿
  pbpaste | mask_logic | tee /dev/tty | pbcopy
  echo -e "\n\033[0;32m✅ 剪貼簿已淨化！\033[0m"
else
  mask_logic "$@"
fi
